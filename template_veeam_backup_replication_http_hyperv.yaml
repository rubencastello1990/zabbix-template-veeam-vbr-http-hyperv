zabbix_export:
  version: '7.2'
  template_groups:
    - uuid: a571c0d144b14fd4a87a9d9b2aa9fcd6
      name: Templates/Applications
  templates:
    - uuid: 0b806f6a30535c91b9cf74d5f7625b42
      template: 'Veeam Backup and Replication by HTTP (Hyper-V enhanced)'
      name: 'Veeam Backup and Replication by HTTP (Hyper-V enhanced)'
      description: |
        This template is designed to monitor Veeam Backup and Replication.
        
        NOTE: The RESTful API may not be available for some editions, see (https://www.veeam.com/licensing-pricing.html) for more details.
        
        Setup:
          1. Create a user to monitor the service or use an existing read-only account.
          See (https://helpcenter.veeam.com/docs/backup/vbr_rest/reference/vbr-rest-v1-rev2.html?ver=110#tag/Login/operation/CreateToken!path=grant_type&t=request) for more details. 
          2. Link the template to a host.
          3. Configure the following macros: {$VEEAM.API.URL}, {$VEEAM.USER}, and {$VEEAM.PASSWORD}.
        
        You can discuss this template or leave feedback on our forum https://www.zabbix.com/forum/zabbix-suggestions-and-feedback/
        
        Generated by official Zabbix template tool "Templator"
      vendor:
        name: Zabbix
        version: 7.2-1-hyperv
      groups:
        - name: Templates/Applications
      items:
        - uuid: 9df2e7ec45b95e18abb5e7ec08c5f9da
          name: 'Get errors'
          type: DEPENDENT
          key: veeam.get.errors
          value_type: TEXT
          description: 'The errors from API requests.'
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.error
              error_handler: CUSTOM_VALUE
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 1h
          master_item:
            key: veeam.get.metrics
          tags:
            - tag: component
              value: status
          triggers:
            - uuid: 6919187e8f145f8b85520fe7eef19344
              expression: 'length(last(/Veeam Backup and Replication by HTTP (Hyper-V enhanced)/veeam.get.errors))>0'
              name: 'Veeam Backup: There are errors in requests to API'
              opdata: '{ITEM.LASTVALUE1}'
              priority: AVERAGE
              description: 'Zabbix has received errors in response to API requests.'
              tags:
                - tag: scope
                  value: availability
        - uuid: 0d77d79737515cc5b69220bf07522cb8
          name: 'Get metrics'
          type: SCRIPT
          key: veeam.get.metrics
          delay: 5m
          history: '0'
          value_type: TEXT
          params: |
            var Veeam = {
            	params: {},
            	token: '',
            
            	setParams: function (params) {
            		['api_endpoint', 'user', 'password', 'created_after'].forEach(function (field) {
            			if (typeof params !== 'object' || typeof params[field] === 'undefined' || params[field] === '') {
            				throw 'Required param is not set: ' + field + '.';
            			}
            		});
            
            		Veeam.params = params;
            		if (typeof Veeam.params.api_endpoint === 'string' && !Veeam.params.api_endpoint.endsWith('/')) {
            			Veeam.params.api_endpoint += '/';
            		}
            		if (Veeam.params.created_after >= 365 || Veeam.params.created_after <= 1) {
            			throw 'Incorrect "created_after" parameter given: ' + Veeam.params.created_after + '\nMust be between 1 and 365 days.';
            		}
            	},
            
            	login: function () {
            
            		var resp, login = new HttpRequest();
            		if (typeof Veeam.params.http_proxy !== 'undefined' && Veeam.params.http_proxy !== '') {
            			login.setProxy(Veeam.params.http_proxy);
            		}
            		login.addHeader('Content-Type: application/x-www-form-urlencoded');
            		login.addHeader('x-api-version: 1.0-rev2');
            		resp = login.post(Veeam.params.api_endpoint + 'api/oauth2/token',
            			'grant_type=password&username=' + encodeURIComponent(Veeam.params.user) + '&password=' + encodeURIComponent(Veeam.params.password));
            
            		if (login.getStatus() !== 200 || resp === null) {
            			throw 'Login failed with status code ' + login.getStatus() + ': ' + resp;
            		}
            
            		try {
            			resp = JSON.parse(resp);
            		}
            		catch (error) {
            			throw 'Failed to parse authentication token for the logon session.';
            		}
            		if (!resp.hasOwnProperty('access_token')) {
            			throw 'Auth response does not contain access token.';
            		}
            		Veeam.token = resp['access_token'];
            
            	},
            
            	request: function (url) {
            
            		var response, request = new HttpRequest();
            		if (typeof Veeam.params.http_proxy !== 'undefined' && Veeam.params.http_proxy !== '') {
            			request.setProxy(Veeam.params.http_proxy);
            		}
            		if (Veeam.token) {
            			request.addHeader('Authorization: Bearer ' + Veeam.token);
            			request.addHeader('x-api-version: 1.0-rev2');
            			response = request.get(url);
            		}
            		if (request.getStatus() !== 200 || response === null) {
            			throw 'Request failed with status code ' + request.getStatus() + ': ' + response;
            		}
            		try {
            			return JSON.parse(response);
            		}
            		catch (error) {
            			throw 'Failed to parse response received from API.';
            		}
            	},
            
            	requestSafe: function (url) {
            
            		var response, request = new HttpRequest(), status;
            		if (typeof Veeam.params.http_proxy !== 'undefined' && Veeam.params.http_proxy !== '') {
            			request.setProxy(Veeam.params.http_proxy);
            		}
            		if (Veeam.token) {
            			request.addHeader('Authorization: Bearer ' + Veeam.token);
            			request.addHeader('x-api-version: 1.0-rev2');
            			response = request.get(url);
            		}
            		status = request.getStatus();
            		if (status !== 200 || response === null) {
            			Zabbix.log(4, '[ VEEAM ] requestSafe: ' + url + ' returned HTTP ' + status + '.');
            			return null;
            		}
            		try {
            			return JSON.parse(response);
            		}
            		catch (error) {
            			Zabbix.log(4, '[ VEEAM ] requestSafe: failed to parse response from ' + url + '.');
            			return null;
            		}
            	},
            
            	getMetricsData: function () {
            		var data = {};
            		ms = 86400000;
            		start_date = new Date((new Date().getTime()) - ms * Veeam.params.created_after).toISOString().replace(/\.\d+/, '');
            		endpoints = {
            			'proxies': 'api/v1/backupInfrastructure/proxies',
            			'managedServers': 'api/v1/backupInfrastructure/managedServers',
            			'repositories_states': 'api/v1/backupInfrastructure/repositories/states',
            			'jobs_states': 'api/v1/jobs/states',
            			'sessions': 'api/v1/sessions?createdAfterFilter=' + encodeURIComponent(start_date)
            		};
            
            		Object.keys(endpoints).forEach(function (key) {
            			data[key] = Veeam.request(Veeam.params.api_endpoint + endpoints[key]);
            		});
            
            		// === Hyper-V enhancement: merge jobs missing from api/v1/jobs/states ===
            		// api/v1/jobs/states only returns VMware vSphere jobs in many VBR versions.
            		// We fetch api/v1/jobs (includes Hyper-V in VBR 12.1+) and derive
            		// state/lastResult from sessions already collected above (no extra HTTP call).
            		var primaryJobs = (data.jobs_states && Array.isArray(data.jobs_states.data))
            			? data.jobs_states.data : [];
            		Zabbix.log(4, '[ VEEAM ] api/v1/jobs/states returned ' + primaryJobs.length + ' job(s).');
            
            		var primaryIds = {};
            		primaryJobs.forEach(function (j) { primaryIds[j.id] = true; });
            
            		var jobsList = Veeam.requestSafe(Veeam.params.api_endpoint + 'api/v1/jobs');
            		var jobsById = {};
            		if (jobsList && Array.isArray(jobsList.data)) {
            			Zabbix.log(4, '[ VEEAM ] api/v1/jobs returned ' + jobsList.data.length + ' job(s).');
            			jobsList.data.forEach(function (j) { if (j.id) jobsById[j.id] = j; });
            		} else {
            			Zabbix.log(4, '[ VEEAM ] api/v1/jobs returned no data.');
            		}
            
            		var sessionsData = (data.sessions && Array.isArray(data.sessions.data))
            			? data.sessions.data : [];
            		var sessionsByJob = {};
            		sessionsData.forEach(function (s) {
            			var jId = s.jobId || s.parentId;
            			if (!jId) return;
            			if (!sessionsByJob[jId]) sessionsByJob[jId] = [];
            			sessionsByJob[jId].push(s);
            		});
            
            		var candidateIds = {};
            		Object.keys(jobsById).forEach(function (id) {
            			if (!primaryIds[id]) candidateIds[id] = true;
            		});
            		Object.keys(sessionsByJob).forEach(function (id) {
            			if (!primaryIds[id]) candidateIds[id] = true;
            		});
            
            		var RUNNING_STATES = ['Starting', 'Working', 'Stopping', 'Pausing', 'Resuming', 'Postprocessing'];
            		var newJobs = [];
            
            		Object.keys(candidateIds).forEach(function (jId) {
            			var jobMeta = jobsById[jId] || null;
            			var jobSessions = sessionsByJob[jId] || [];
            			jobSessions.sort(function (a, b) {
            				return new Date(b.creationTime || 0) - new Date(a.creationTime || 0);
            			});
            			var latest = jobSessions[0] || null;
            			if (!jobMeta && !latest) return;
            
            			var isActive = latest && RUNNING_STATES.indexOf(latest.state) !== -1;
            			var isDisabled = jobMeta && (
            				jobMeta.isDisabled === true ||
            				(jobMeta.schedule && jobMeta.schedule.runAutomatically === false) ||
            				jobMeta.isScheduleEnabled === false
            			);
            			var status = isActive ? 'running' : (isDisabled ? 'disabled' : 'inactive');
            
            			var lastResult = 'None';
            			if (latest) {
            				var r = latest.result;
            				if (r && typeof r === 'object') lastResult = r.result || 'None';
            				else if (typeof r === 'string') lastResult = r;
            			}
            
            			var jobName = (jobMeta && jobMeta.name)
            				|| (latest && (latest.jobName || latest.name)) || 'Unknown';
            			var workload = (jobMeta && (jobMeta.workload || jobMeta.platform)) || 'HyperV';
            			var jobType = (jobMeta && (jobMeta.type || jobMeta.jobType))
            				|| (latest && latest.sessionType) || 'BackupJob';
            			var repoName = (jobMeta && jobMeta.storage &&
            				(jobMeta.storage.backupRepositoryName || jobMeta.storage.backupRepositoryId)) || '';
            
            			newJobs.push({
            				id: jId,
            				name: jobName,
            				type: jobType,
            				workload: workload,
            				status: status,
            				lastResult: lastResult,
            				repositoryName: repoName
            			});
            		});
            
            		if (newJobs.length > 0) {
            			Zabbix.log(4, '[ VEEAM ] Hyper-V fallback: added ' + newJobs.length + ' job(s) via api/v1/jobs + sessions.');
            		} else {
            			Zabbix.log(4, '[ VEEAM ] Hyper-V fallback: no additional jobs found (VMware-only or already complete).');
            		}
            
            		if (!data.jobs_states) { data.jobs_states = {data: []}; }
            		if (!Array.isArray(data.jobs_states.data)) { data.jobs_states.data = []; }
            		data.jobs_states.data = data.jobs_states.data.concat(newJobs);
            
            		return data;
            	}
            };
            
            try {
            	Veeam.setParams(JSON.parse(value));
            	Veeam.login();
            	return JSON.stringify(Veeam.getMetricsData());
            }
            catch (error) {
            	error += (String(error).endsWith('.')) ? '' : '.';
            	Zabbix.log(3, '[ VEEAM ] ERROR: ' + error);
            	return JSON.stringify({ 'error': error });
            }
          description: 'The result of API requests is expressed in the JSON.'
          timeout: '{$VEEAM.DATA.TIMEOUT}'
          parameters:
            - name: api_endpoint
              value: '{$VEEAM.API.URL}'
            - name: created_after
              value: '{$CREATED.AFTER}'
            - name: http_proxy
              value: '{$VEEAM.HTTP.PROXY}'
            - name: password
              value: '{$VEEAM.PASSWORD}'
            - name: user
              value: '{$VEEAM.USER}'
          tags:
            - tag: component
              value: raw
      discovery_rules:
        - uuid: 8f26443c0bd45cfdbe6f1db9c8b5064e
          name: 'Jobs states discovery'
          type: DEPENDENT
          key: veeam.job.state.discovery
          filter:
            evaltype: AND
            conditions:
              - macro: '{#JOB.STATUS}'
                value: '{$JOB.STATUS.MATCHES}'
              - macro: '{#JOB.STATUS}'
                value: '{$JOB.STATUS.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#NAME}'
                value: '{$JOB.NAME.MATCHES}'
              - macro: '{#NAME}'
                value: '{$JOB.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#TYPE}'
                value: '{$JOB.TYPE.MATCHES}'
              - macro: '{#TYPE}'
                value: '{$JOB.TYPE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          description: 'Discovery of the jobs states.'
          item_prototypes:
            - uuid: a3644abf82b45bb98b8429c5377b8b2c
              name: 'Job states [{#NAME}] [{#TYPE}]: Last result'
              type: DEPENDENT
              key: 'veeam.jobs.last.result[{#ID}]'
              value_type: TEXT
              description: 'The result of the session. The enums used: `None`, `Success`, `Warning`, `Failed`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.lastResult
              master_item:
                key: 'veeam.jobs.states.raw[{#ID}]'
              tags:
                - tag: component
                  value: jobs
                - tag: job
                  value: '{#NAME}'
                - tag: workload
                  value: '{#WORKLOAD}'
              trigger_prototypes:
                - uuid: 9db0384f27775b9c98bc3e62f345eb76
                  expression: 'find(/Veeam Backup and Replication by HTTP (Hyper-V enhanced)/veeam.jobs.last.result[{#ID}],,"like","Failed")=1'
                  name: 'Veeam Backup: Last result job failed'
                  event_name: 'Veeam Backup: Failed job [{#NAME}]'
                  priority: AVERAGE
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: availability
            - uuid: 1e7bc7a654665e63bd9b7b8505e89dfd
              name: 'Job states [{#NAME}] [{#TYPE}]: Get data'
              type: DEPENDENT
              key: 'veeam.jobs.states.raw[{#ID}]'
              history: '0'
              value_type: TEXT
              description: 'Gets raw data from the job states with the name `[{#NAME}]`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.jobs_states.data.[?(@.id==''{#ID}'')].first()'
              master_item:
                key: veeam.get.metrics
              tags:
                - tag: component
                  value: jobs
                - tag: component
                  value: raw
            - uuid: f90297e6bd7e56ff9399f037568bf982
              name: 'Job states [{#NAME}] [{#TYPE}]: Status'
              type: DEPENDENT
              key: 'veeam.jobs.status[{#ID}]'
              value_type: TEXT
              description: 'The current status of the job. The enums used: `running`, `inactive`, `disabled`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.status
              master_item:
                key: 'veeam.jobs.states.raw[{#ID}]'
              tags:
                - tag: component
                  value: jobs
                - tag: job
                  value: '{#NAME}'
                - tag: workload
                  value: '{#WORKLOAD}'
          master_item:
            key: veeam.get.metrics
          lld_macro_paths:
            - lld_macro: '{#ID}'
              path: $.id
            - lld_macro: '{#JOB.STATUS}'
              path: $.status
            - lld_macro: '{#NAME}'
              path: $.name
            - lld_macro: '{#REPOSITORY.NAME}'
              path: $.repositoryName
            - lld_macro: '{#TYPE}'
              path: $.type
            - lld_macro: '{#WORKLOAD}'
              path: $.workload
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.jobs_states.data
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
        - uuid: 86135768fc6f54c0a0776cc3ba9c5cd0
          name: 'Proxies discovery'
          type: DEPENDENT
          key: veeam.proxies.discovery
          filter:
            evaltype: AND
            conditions:
              - macro: '{#NAME}'
                value: '{$PROXIES.NAME.MATCHES}'
              - macro: '{#NAME}'
                value: '{$PROXIES.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#TYPE}'
                value: '{$PROXIES.TYPE.MATCHES}'
              - macro: '{#TYPE}'
                value: '{$PROXIES.TYPE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          description: 'Discovery of proxies.'
          item_prototypes:
            - uuid: f91662102c3559b1877b84b668ac3a9e
              name: 'Proxy [{#NAME}] [{#TYPE}]: Max Task Count'
              type: DEPENDENT
              key: 'veeam.proxy.maxtask[{#NAME}]'
              description: 'The maximum number of concurrent tasks.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.server.maxTaskCount
              master_item:
                key: 'veeam.proxy.raw[{#NAME}]'
              tags:
                - tag: component
                  value: proxies
                - tag: proxy
                  value: '{#NAME}'
            - uuid: 7eb2320807145212ad27a78ee8badce4
              name: 'Proxy [{#NAME}] [{#TYPE}]: Get data'
              type: DEPENDENT
              key: 'veeam.proxy.raw[{#NAME}]'
              history: '0'
              value_type: TEXT
              description: 'Gets raw data collected by the proxy with the name `[{#NAME}]`, `[{#TYPE}]`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.proxies.data.[?(@.id==''{#ID}'')].first()'
              master_item:
                key: veeam.get.metrics
              tags:
                - tag: component
                  value: proxies
                - tag: component
                  value: raw
                - tag: proxy
                  value: '{#NAME}'
            - uuid: 2d078b73f8275d67aa5dbea5de8fa0c7
              name: 'Proxy [{#NAME}] [{#TYPE}]: Host name'
              type: DEPENDENT
              key: 'veeam.proxy.server.name[{#NAME}]'
              value_type: TEXT
              description: 'The name of the proxy server.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.name
              master_item:
                key: 'veeam.proxy.server.raw[{#NAME}]'
              tags:
                - tag: component
                  value: proxies
                - tag: proxy
                  value: '{#NAME}'
            - uuid: 2ee6f8179e765736b34481d1da6dbb04
              name: 'Server [{#NAME}]: Get data'
              type: DEPENDENT
              key: 'veeam.proxy.server.raw[{#NAME}]'
              history: '0'
              value_type: TEXT
              description: 'Gets raw data collected by the proxy server.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.managedServers.data.[?(@.id==''{#HOSTID}'')].first()'
              master_item:
                key: veeam.get.metrics
              tags:
                - tag: component
                  value: proxies
                - tag: component
                  value: raw
                - tag: proxy
                  value: '{#NAME}'
            - uuid: 2b3c8718a6cc57a9a0ccb2da02c1860f
              name: 'Proxy [{#NAME}] [{#TYPE}]: Host type'
              type: DEPENDENT
              key: 'veeam.proxy.server.type[{#NAME}]'
              value_type: TEXT
              description: 'The type of the proxy server.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.type
              master_item:
                key: 'veeam.proxy.server.raw[{#NAME}]'
              tags:
                - tag: component
                  value: proxies
                - tag: proxy
                  value: '{#NAME}'
          master_item:
            key: veeam.get.metrics
          lld_macro_paths:
            - lld_macro: '{#DESCRIPTION}'
              path: $.description
            - lld_macro: '{#HOSTID}'
              path: $.server.hostId
            - lld_macro: '{#ID}'
              path: $.id
            - lld_macro: '{#NAME}'
              path: $.name
            - lld_macro: '{#TYPE}'
              path: $.type
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.proxies.data
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
        - uuid: 6182bdaad4dc56ff9a107316815429e5
          name: 'Repositories discovery'
          type: DEPENDENT
          key: veeam.repositories.discovery
          filter:
            evaltype: AND
            conditions:
              - macro: '{#NAME}'
                value: '{$REPOSITORIES.NAME.MATCHES}'
              - macro: '{#NAME}'
                value: '{$REPOSITORIES.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#TYPE}'
                value: '{$REPOSITORIES.TYPE.MATCHES}'
              - macro: '{#TYPE}'
                value: '{$REPOSITORIES.TYPE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          description: 'Discovery of repositories.'
          item_prototypes:
            - uuid: 86ca5bda6d3e5809beeee4a40aa223e1
              name: 'Repository [{#NAME}] [{#TYPE}]: Get data'
              type: DEPENDENT
              key: 'veeam.repositories.raw[{#NAME}]'
              history: '0'
              value_type: TEXT
              description: 'Gets raw data from repository with the name: `[{#NAME}]`, `[{#TYPE}]`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.repositories_states.data.[?(@.id==''{#ID}'')].first()'
              master_item:
                key: veeam.get.metrics
              tags:
                - tag: component
                  value: raw
                - tag: component
                  value: repositories
                - tag: repository
                  value: '{#NAME}'
            - uuid: 8482a4045e71515cacacc99b4f2580a8
              name: 'Repository [{#NAME}] [{#TYPE}]: Used space [{#PATH}]'
              type: DEPENDENT
              key: 'veeam.repository.capacity[{#NAME}]'
              value_type: FLOAT
              units: '!GB'
              description: 'Used space by repositories expressed in gigabytes (GB).'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.usedSpaceGB
              master_item:
                key: 'veeam.repositories.raw[{#NAME}]'
              tags:
                - tag: component
                  value: repositories
                - tag: repository
                  value: '{#NAME}'
            - uuid: 08ed7149fe9757ab87d01a531ce07592
              name: 'Repository [{#NAME}] [{#TYPE}]: Free space [{#PATH}]'
              type: DEPENDENT
              key: 'veeam.repository.free.space[{#NAME}]'
              value_type: FLOAT
              units: '!GB'
              description: 'Free space of repositories expressed in gigabytes (GB).'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.freeGB
              master_item:
                key: 'veeam.repositories.raw[{#NAME}]'
              tags:
                - tag: component
                  value: repositories
                - tag: repository
                  value: '{#NAME}'
          master_item:
            key: veeam.get.metrics
          lld_macro_paths:
            - lld_macro: '{#DESCRIPTION}'
              path: $.description
            - lld_macro: '{#HOSTID}'
              path: $.server.hostId
            - lld_macro: '{#HOSTNAME}'
              path: $.hostName
            - lld_macro: '{#ID}'
              path: $.id
            - lld_macro: '{#NAME}'
              path: $.name
            - lld_macro: '{#PATH}'
              path: $.path
            - lld_macro: '{#TYPE}'
              path: $.type
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.repositories_states.data
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
        - uuid: 1b24055bc3015a67b19ac53fc0713d4e
          name: 'Sessions discovery'
          type: DEPENDENT
          key: veeam.sessions.discovery
          filter:
            evaltype: AND
            conditions:
              - macro: '{#NAME}'
                value: '{$SESSION.NAME.MATCHES}'
              - macro: '{#NAME}'
                value: '{$SESSION.NAME.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
              - macro: '{#TYPE}'
                value: '{$SESSION.TYPE.MATCHES}'
              - macro: '{#TYPE}'
                value: '{$SESSION.TYPE.NOT_MATCHES}'
                operator: NOT_MATCHES_REGEX
          description: 'Discovery of sessions.'
          item_prototypes:
            - uuid: a66f96c767f75bcbb33012214994c699
              name: 'Session [{#NAME}] [{#TYPE}]: Message'
              type: DEPENDENT
              key: 'veeam.sessions.message[{#ID}]'
              value_type: TEXT
              description: 'A message that explains the session result.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.result.message
              master_item:
                key: 'veeam.sessions.raw[{#ID}]'
              tags:
                - tag: component
                  value: sessions
                - tag: creation-date
                  value: '{#CREATION.TIME}'
                - tag: session
                  value: '{#NAME}'
            - uuid: 4e974cd7afa95023afb81e24fb8c6add
              name: 'Session progress percent [{#NAME}] [{#TYPE}]'
              type: DEPENDENT
              key: 'veeam.sessions.progress.percent[{#ID}]'
              value_type: FLOAT
              units: '%'
              description: 'The progress of the session expressed as percentage.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.progressPercent
              master_item:
                key: 'veeam.sessions.raw[{#ID}]'
              tags:
                - tag: component
                  value: sessions
                - tag: creation-date
                  value: '{#CREATION.TIME}'
                - tag: session
                  value: '{#NAME}'
            - uuid: 4ae3ac48e19b5b43b746d72c9780ca5e
              name: 'Session [{#NAME}] [{#TYPE}]: Get data'
              type: DEPENDENT
              key: 'veeam.sessions.raw[{#ID}]'
              history: '0'
              value_type: TEXT
              description: 'Gets raw data from session with the name: `[{#NAME}]`, `[{#TYPE}]`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - '$.sessions.data.[?(@.id==''{#ID}'')].first()'
                  error_handler: DISCARD_VALUE
              master_item:
                key: veeam.get.metrics
              tags:
                - tag: component
                  value: raw
                - tag: session
                  value: '{#NAME}'
            - uuid: 2d0441f503835564b5c9ba88e64e5946
              name: 'Session [{#NAME}] [{#TYPE}]: Result'
              type: DEPENDENT
              key: 'veeam.sessions.result[{#ID}]'
              value_type: TEXT
              description: 'The result of the session. The enums used: `None`, `Success`, `Warning`, `Failed`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.result.result
              master_item:
                key: 'veeam.sessions.raw[{#ID}]'
              tags:
                - tag: component
                  value: sessions
                - tag: creation-date
                  value: '{#CREATION.TIME}'
                - tag: session
                  value: '{#NAME}'
              trigger_prototypes:
                - uuid: a2b13288ccbb592c9b5dee5a941a8992
                  expression: 'find(/Veeam Backup and Replication by HTTP (Hyper-V enhanced)/veeam.sessions.result[{#ID}],,"like","Failed")=1'
                  name: 'Veeam Backup: Last result session failed'
                  event_name: 'Veeam Backup: Failed session [{#NAME}]'
                  priority: AVERAGE
                  manual_close: 'YES'
                  tags:
                    - tag: scope
                      value: availability
            - uuid: 8f45516a6e6252bc97725a8ca6e8a196
              name: 'Session [{#NAME}] [{#TYPE}]: State'
              type: DEPENDENT
              key: 'veeam.sessions.state[{#ID}]'
              value_type: TEXT
              description: 'The state of the session. The enums used: `Stopped`, `Starting`, `Stopping`, `Working`, `Pausing`, `Resuming`, `WaitingTape`, `Idle`, `Postprocessing`, `WaitingRepository`, `WaitingSlot`.'
              preprocessing:
                - type: JSONPATH
                  parameters:
                    - $.state
              master_item:
                key: 'veeam.sessions.raw[{#ID}]'
              tags:
                - tag: component
                  value: sessions
                - tag: creation-date
                  value: '{#CREATION.TIME}'
                - tag: session
                  value: '{#NAME}'
          master_item:
            key: veeam.get.metrics
          lld_macro_paths:
            - lld_macro: '{#CREATION.TIME}'
              path: $.creationTime
            - lld_macro: '{#END.TIME}'
              path: $.endTime
            - lld_macro: '{#ID}'
              path: $.id
            - lld_macro: '{#NAME}'
              path: $.name
            - lld_macro: '{#STATE}'
              path: $.state
            - lld_macro: '{#TYPE}'
              path: $.sessionType
          preprocessing:
            - type: JSONPATH
              parameters:
                - $.sessions.data
            - type: JAVASCRIPT
              parameters:
                - |
                  obj = JSON.parse(value, function (key, value) {
                  	if (key == 'creationTime') return new Date(value).toDateString();
                  	return value;
                  });
                  return JSON.stringify(obj);
            - type: DISCARD_UNCHANGED_HEARTBEAT
              parameters:
                - 6h
      tags:
        - tag: class
          value: software
        - tag: target
          value: veeam
      macros:
        - macro: '{$CREATED.AFTER}'
          value: '7'
          description: 'Returns sessions that are created after chosen days.'
        - macro: '{$JOB.NAME.MATCHES}'
          value: '.*'
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$JOB.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$JOB.STATUS.MATCHES}'
          value: '.*'
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$JOB.STATUS.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$JOB.TYPE.MATCHES}'
          value: '.*'
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$JOB.TYPE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in discovery rule to evaluate the states of jobs.'
        - macro: '{$PROXIES.NAME.MATCHES}'
          value: '.*'
          description: 'This macro is used in proxies discovery rule.'
        - macro: '{$PROXIES.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in proxies discovery rule.'
        - macro: '{$PROXIES.TYPE.MATCHES}'
          value: '.*'
          description: 'This macro is used in proxies discovery rule.'
        - macro: '{$PROXIES.TYPE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in proxies discovery rule.'
        - macro: '{$REPOSITORIES.NAME.MATCHES}'
          value: '.*'
          description: 'This macro is used in repositories discovery rule.'
        - macro: '{$REPOSITORIES.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in repositories discovery rule.'
        - macro: '{$REPOSITORIES.TYPE.MATCHES}'
          value: '.*'
          description: 'This macro is used in repositories discovery rule.'
        - macro: '{$REPOSITORIES.TYPE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in repositories discovery rule.'
        - macro: '{$SESSION.NAME.MATCHES}'
          value: '.*'
          description: 'This macro is used in discovery rule to evaluate sessions.'
        - macro: '{$SESSION.NAME.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in discovery rule to evaluate sessions.'
        - macro: '{$SESSION.TYPE.MATCHES}'
          value: '.*'
          description: 'This macro is used in discovery rule to evaluate sessions.'
        - macro: '{$SESSION.TYPE.NOT_MATCHES}'
          value: CHANGE_IF_NEEDED
          description: 'This macro is used in discovery rule to evaluate sessions.'
        - macro: '{$VEEAM.API.URL}'
          value: 'https://localhost:9419'
          description: 'The Veeam API endpoint is a URL in the format `<scheme>://<host>:<port>`.'
        - macro: '{$VEEAM.DATA.TIMEOUT}'
          value: '10'
          description: 'A response timeout for the API.'
        - macro: '{$VEEAM.HTTP.PROXY}'
          description: 'Sets the HTTP proxy to `http_proxy` value. If this parameter is empty, then no proxy is used.'
        - macro: '{$VEEAM.PASSWORD}'
          type: SECRET_TEXT
          description: 'The `password` of the Veeam Backup and Replication account. It is used to obtain an access token.'
        - macro: '{$VEEAM.USER}'
          type: SECRET_TEXT
          description: 'The `username` of the Veeam Backup and Replication account. It is used to obtain an access token.'
